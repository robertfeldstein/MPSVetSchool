---
title: "EDA"
author: "Melissa Eckert, Robert Feldstein, Yue Li, Haonan Chen"
date: "`r Sys.Date()`"
output: pdf_document
---
# Exploratory Data Analysis

Load packages
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(dotenv)
library(openxlsx)
library(tidyxl)
library(dplyr)
library(ggplot2)
library(tidyr)
```

Load data 
```{r}
df <- read.xlsx("Data/FinalDataSet.xlsx", sheet = 1)
```

# Data Summary

```{r}
summary(df)
```

## Repetition of Python Work

```{r}

# Make a dataset that is just the first core attributes 
core_scores <- c("UniqueID", "strBlock", "service", "medical", "clinical_reasoning", "professionalism", "collaboration")
core_df <- df[, core_scores]

# Remove rows with missing values
core_df <- core_df %>% na.omit()

# Group by strBlock to get the mean of each core attribute at each rotation
core_df_grouped <- core_df %>% group_by(strBlock) %>% summarise_all(mean)
core_df_grouped <- core_df_grouped %>% select(-UniqueID) %>% select(-service)

# Plot the mean scores over the strBlocks

core_df_grouped_long <- gather(core_df_grouped, key = "Attribute", value = "Score", -strBlock)

ggplot(core_df_grouped_long, aes(x = strBlock, y = Score, color = Attribute)) + geom_line() + geom_point() + labs(title = "Mean Scores of Core Attributes Over Time", x = "Rotation", y = "Mean Score") + theme_minimal()





```

```{r}
# Make correlation matrix

core_df_cor <- core_df %>% select(-UniqueID) %>% select(-strBlock)  %>% select(-service)
core_df_cor <- cor(core_df_cor)

# Make into heatmap
ggplot(data = as.data.frame(as.table(core_df_cor)), aes(Var1, Var2, fill = Freq)) + geom_tile() + scale_fill_gradient2(low = "blue", high = "red", mid = "white", midpoint = 0) + theme_minimal() + labs(title = "Correlation Matrix of Core Attributes", x = "Attribute", y = "Attribute", fill = "Correlation") + theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

```{r}
# Make some violin plots of the core attributes with the other attributes 

# predictive variables (these are binary)
non_score_vars <- c("Hosp", "Early", "PIPActive", "PIPYN")
score_categories <- c("medical", "clinical_reasoning", "professionalism", "collaboration")

boxplot <- function(df, x, y) {
  df_filtered <- df %>%
    filter(!is.na(.data[[x]]), !is.na(.data[[y]])) %>%
    mutate(!!x := as.factor(.data[[x]]))
  
  p <- ggplot(df_filtered, aes(x = .data[[x]], y = .data[[y]], fill = .data[[x]])) +
    geom_boxplot(outlier.shape = 21, outlier.fill = "white", outlier.size = 2, width = 0.6) + 
    stat_summary(fun = mean, geom = "point", shape = 23, size = 3, fill = "red") +  # Mean as red diamond
    scale_fill_brewer(palette = "Set2") +  # Use a distinct color palette
    ggtitle(paste("Boxplot of", y, "by", x)) +
    xlab(x) +
    ylab(y) +
    theme_minimal(base_size = 14) +
    theme(legend.position = "none", 
          axis.text.x = element_text(angle = 45, hjust = 1),
          plot.title = element_text(face = "bold", hjust = 0.5))
  
  print(p)
}

for (var in non_score_vars) {
  for (cat in score_categories) {
    boxplot(df, var, cat)
  }
}


```

## Is the data normally distributed?

```{r}

# Histogram of the core_scores 

core_vals <- c("medical", "clinical_reasoning", "professionalism", "collaboration")


for (val in core_vals) {
  hist(df[[val]], main = paste("Histogram of", val), xlab = val)
}


```

Obviously collaboration and professionalism are not normally distributed, they are basically just straight line increases where the vast majority of students are scoring well in both categories across all of the rotations. It may be a good idea to consider re-evaluating the way these scores are calculated in order to flatten out the curve.

Medical and clinical reasoning could potentially look like a discrete gaussian distribution. At least at first glance they seem roughly bell-curve shaped. Of course, discrete data cannot be normal.


```{r}
# Discretized data cannot be normally distributed, but we can still test for a different guide of normality



# Use a discrete normality test to see if the data is normally distributed


```



